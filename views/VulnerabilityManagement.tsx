import React, { useState, useEffect } from 'react';
import { AlertTriangle, ShieldCheck, ShieldAlert, Info, ExternalLink, RefreshCw } from 'lucide-react';


const API_URL = '/api';

const VulnerabilityManagement = () => {
    const [vulnerabilities, setVulnerabilities] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);

    const fetchVulns = async () => {
        setLoading(true);
        try {
            const res = await fetch(`${API_URL}/vulnerabilities`);
            const data = await res.json();
            setVulnerabilities(data);
        } catch (err) {
            console.error("Failed to fetch vulnerabilities:", err);
        }
        setLoading(false);
    };

    useEffect(() => {
        fetchVulns();
    }, []);

    const getSeverityStyle = (severity: string) => {
        switch (severity.toLowerCase()) {
            case 'critical': return { color: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)', border: 'rgba(239, 68, 68, 0.2)' };
            case 'high': return { color: '#f97316', bg: 'rgba(249, 115, 22, 0.1)', border: 'rgba(249, 115, 22, 0.2)' };
            case 'medium': return { color: '#eab308', bg: 'rgba(234, 179, 8, 0.1)', border: 'rgba(234, 179, 8, 0.2)' };
            default: return { color: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)', border: 'rgba(59, 130, 246, 0.2)' };
        }
    };

    const getStatusIcon = (status: string) => {
        switch (status.toLowerCase()) {
            case 'pending': return <ShieldAlert size={16} color="#ef4444" />;
            case 'mitigated': return <ShieldCheck size={16} color="#22c55e" />;
            default: return <Info size={16} color="#3b82f6" />;
        }

    };

    return (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <div>
                    <h2 style={{ fontSize: '1.25rem', fontWeight: 700, marginBottom: '4px' }}>Vulnerability Management</h2>
                    <p style={{ color: 'var(--text-secondary)', fontSize: '0.875rem' }}>Track and manage security flaws across your endpoints.</p>
                </div>
                <button
                    onClick={fetchVulns}
                    className="btn btn-ghost"
                    style={{ gap: '8px', border: '1px solid var(--border-color)' }}
                >
                    <RefreshCw size={16} className={loading ? 'animate-spin' : ''} />
                    Refresh
                </button>
            </div>

            <div className="card" style={{ padding: 0 }}>
                <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '0.9rem' }}>
                    <thead>
                        <tr style={{ borderBottom: '1px solid var(--border-color)', color: 'var(--text-muted)', textAlign: 'left', fontSize: '0.75rem', textTransform: 'uppercase' }}>
                            <th style={{ padding: '20px' }}>CVE ID</th>
                            <th style={{ padding: '20px' }}>Severity</th>
                            <th style={{ padding: '20px' }}>Affected Host</th>
                            <th style={{ padding: '20px' }}>Description</th>
                            <th style={{ padding: '20px' }}>Status</th>
                            <th style={{ padding: '20px', textAlign: 'right' }}>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {loading ? (
                            <tr>
                                <td colSpan={6} style={{ padding: '40px', textAlign: 'center' }}>
                                    <RefreshCw className="animate-spin" style={{ margin: '0 auto', color: 'var(--sentinel-blue)' }} />
                                </td>
                            </tr>
                        ) : vulnerabilities.length === 0 ? (
                            <tr>
                                <td colSpan={6} style={{ padding: '40px', textAlign: 'center', color: 'var(--text-muted)' }}>
                                    No vulnerabilities detected.
                                </td>
                            </tr>
                        ) : vulnerabilities.map((vuln) => {
                            const style = getSeverityStyle(vuln.severity);
                            return (
                                <tr key={vuln.id} style={{ borderBottom: '1px solid var(--border-color)' }}>
                                    <td style={{ padding: '20px' }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', fontWeight: 600 }}>
                                            {vuln.cve}
                                            <ExternalLink size={12} style={{ color: 'var(--text-muted)', cursor: 'pointer' }} />
                                        </div>
                                    </td>
                                    <td style={{ padding: '20px' }}>
                                        <span style={{
                                            padding: '4px 10px',
                                            borderRadius: '4px',
                                            fontSize: '0.7rem',
                                            fontWeight: 700,
                                            color: style.color,
                                            backgroundColor: style.bg,
                                            border: `1px solid ${style.border}`,
                                            textTransform: 'uppercase'
                                        }}>
                                            {vuln.severity}
                                        </span>
                                    </td>
                                    <td style={{ padding: '20px', color: 'var(--sentinel-blue)', fontWeight: 500 }}>{vuln.host}</td>
                                    <td style={{ padding: '20px', color: 'var(--text-secondary)', maxWidth: '300px' }}>{vuln.description}</td>
                                    <td style={{ padding: '20px' }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '0.85rem' }}>
                                            {getStatusIcon(vuln.status)}
                                            <span style={{ textTransform: 'capitalize' }}>{vuln.status}</span>
                                        </div>
                                    </td>
                                    <td style={{ padding: '20px', textAlign: 'right' }}>
                                        <button className="btn btn-ghost" style={{ fontSize: '0.75rem', color: 'var(--sentinel-green)', padding: '4px 8px' }}>
                                            REMEDIATE
                                        </button>
                                    </td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            </div>

            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '24px' }}>
                <div className="card">
                    <h3 style={{ fontSize: '1rem', fontWeight: 600, marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <AlertTriangle size={20} color="#eab308" />
                        Top Risks
                    </h3>
                    <p style={{ fontSize: '0.85rem', color: 'var(--text-secondary)', lineHeight: '1.6' }}>
                        The following hosts have high-severity vulnerabilities that require immediate attention.
                    </p>
                    <div style={{ marginTop: '16px', display: 'flex', flexDirection: 'column', gap: '12px' }}>
                        {vulnerabilities.filter(v => v.severity === 'critical' || v.severity === 'high').slice(0, 3).map(v => (
                            <div key={v.id} style={{ padding: '12px', background: 'rgba(255,255,255,0.03)', borderRadius: '8px', border: '1px solid var(--border-color)', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <div>
                                    <div style={{ fontWeight: 600, fontSize: '0.85rem' }}>{v.host}</div>
                                    <div style={{ fontSize: '0.75rem', color: 'rgba(239, 68, 68, 0.8)' }}>{v.cve}</div>
                                </div>
                                <button className="btn btn-primary" style={{ padding: '4px 8px', fontSize: '0.7rem' }}>FIX</button>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </div>
    );
};

export default VulnerabilityManagement;
